From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mark Vainomaa <mikroskeem@mikroskeem.eu>
Date: Wed, 29 May 2019 20:40:02 +0300
Subject: [PATCH] Speed up shutdown


diff --git a/api/src/main/java/eu/mikroskeem/mikrocord/api/config/MikroCordProxyConfig.java b/api/src/main/java/eu/mikroskeem/mikrocord/api/config/MikroCordProxyConfig.java
index ae01835f93427f5da2e97828ec4df64fb44a3fb6..18ae1661fc45b12310b31496bac38e84f57e50d0 100644
--- a/api/src/main/java/eu/mikroskeem/mikrocord/api/config/MikroCordProxyConfig.java
+++ b/api/src/main/java/eu/mikroskeem/mikrocord/api/config/MikroCordProxyConfig.java
@@ -50,4 +50,9 @@ public interface MikroCordProxyConfig {
      * @return TCP Fast Open mode
      */
     int getTcpFastOpenMode();
+
+    /**
+     * @return Whether proxy should wait for all players to disconnect infinitely or not
+     */
+    boolean isWaitForAllPlayersToDisconnectInfinitely();
 }
diff --git a/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java b/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
index 3c08a652fe46613b7cff056ce54f71c54583b3d6..e1fb1f92553fcf53ff56a2624cb9d7af8b367489 100644
--- a/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
+++ b/proxy/src/main/java/eu/mikroskeem/mikrocord/conf/MikroCordConfiguration.java
@@ -43,6 +43,9 @@ public class MikroCordConfiguration extends WaterfallConfiguration {
     @Getter
     private int tcpFastOpenMode = TCPFastOpenMode.CLIENT_ONLY.value;
 
+    @Getter
+    private boolean waitForAllPlayersToDisconnectInfinitely = true;
+
     @Override
     public void load() {
         super.load();
@@ -57,6 +60,7 @@ public class MikroCordConfiguration extends WaterfallConfiguration {
         velocityForwardingSecret = config.getString("velocity_modern_forwarding.secret", () -> VelocitySupport.generateRandomString(12)).getBytes(StandardCharsets.UTF_8);
         tcpFastOpenEnabled = config.getBoolean("networking.tcp_fast_open.enabled", tcpFastOpenEnabled);
         tcpFastOpenMode = setupTfo(config.getInt("networking.tcp_fast_open.mode", tcpFastOpenMode));
+        waitForAllPlayersToDisconnectInfinitely = config.getBoolean("shutdown.wait_for_all_players_to_disconnect_infinitely", waitForAllPlayersToDisconnectInfinitely);
     }
 
     private int setupTfo(int value) {
diff --git a/proxy/src/main/java/net/md_5/bungee/BungeeCord.java b/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
index 8360483b65cf685279cddbb28fb159d29c94e876..4d1d95383d8bb39b713904b0daf2031676dee639 100644
--- a/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
+++ b/proxy/src/main/java/net/md_5/bungee/BungeeCord.java
@@ -475,12 +475,39 @@ public class BungeeCord extends ProxyServer
                     connectionLock.readLock().unlock();
                 }
 
+                /* MikroCord start - wait for all players to disconnect instead of using hardcoded delay
                 try
                 {
                     Thread.sleep( 500 );
                 } catch ( InterruptedException ex )
                 {
                 }
+                */
+                Collection<UserConnection> disconnectingPlayers;
+                try {
+                    connectionLock.readLock().lock();
+                    disconnectingPlayers = java.util.Set.copyOf(connections.values());
+                } finally {
+                    connectionLock.readLock().unlock();
+                }
+                try {
+                    var disconnectFuture = java.util.concurrent.CompletableFuture
+                            .allOf(disconnectingPlayers.stream()
+                                    .map(UserConnection::getDisconnectFuture)
+                                    .toArray(java.util.concurrent.CompletableFuture[]::new));
+                    if (config.isWaitForAllPlayersToDisconnectInfinitely()) {
+                        disconnectFuture.get();
+                    } else {
+                        disconnectFuture.get(10, TimeUnit.SECONDS);
+                    }
+                } catch (java.util.concurrent.ExecutionException e) {
+                    throw new RuntimeException(e);
+                } catch (java.util.concurrent.TimeoutException e) {
+                    getLogger().log(Level.WARNING, "Timeout while waiting all players to clean up - something is taking too long!", e);
+                } catch (InterruptedException e) {
+                    Thread.currentThread().interrupt();
+                }
+                // MikroCord end
 
                 if ( reconnectHandler != null )
                 {
@@ -511,8 +538,8 @@ public class BungeeCord extends ProxyServer
                 }
 
                 getLogger().info( "Closing IO threads" );
-                bossEventLoopGroup.shutdownGracefully();
-                workerEventLoopGroup.shutdownGracefully();
+                bossEventLoopGroup.shutdownGracefully(100, 5000, TimeUnit.MILLISECONDS); // MikroCord - speed up shutdown
+                workerEventLoopGroup.shutdownGracefully(100, 5000, TimeUnit.MILLISECONDS); // MikroCord - speed up shutdown
                 while (true) {
                     try {
                         bossEventLoopGroup.awaitTermination(Long.MAX_VALUE, TimeUnit.NANOSECONDS);
diff --git a/proxy/src/main/java/net/md_5/bungee/UserConnection.java b/proxy/src/main/java/net/md_5/bungee/UserConnection.java
index 42c025025d9de95186faaaa881899fd774b0b439..b657ebdce63b3004f3b150d056390fbfd4f10ec3 100644
--- a/proxy/src/main/java/net/md_5/bungee/UserConnection.java
+++ b/proxy/src/main/java/net/md_5/bungee/UserConnection.java
@@ -154,6 +154,7 @@ public final class UserConnection implements ProxiedPlayer, eu.mikroskeem.mikroc
             ch.write( packet );
         }
     };
+    @Getter private final java.util.concurrent.CompletableFuture<Void> disconnectFuture = new java.util.concurrent.CompletableFuture<>(); // MikroCord - wait for all players to disconnect instead of using hardcoded delay
 
     public void init()
     {
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/UpstreamBridge.java b/proxy/src/main/java/net/md_5/bungee/connection/UpstreamBridge.java
index 51d0c6cfe58e9f59c1c897ecf13a27ca60830fb8..cb52bd781b09cb5c471fdcadb93e70785e934716 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/UpstreamBridge.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/UpstreamBridge.java
@@ -87,6 +87,7 @@ public class UpstreamBridge extends PacketHandler
             }
             con.getServer().disconnect( "Quitting" );
         }
+        this.con.getDisconnectFuture().complete(null); // MikroCord - wait for all players to disconnect instead of using hardcoded delay
     }
 
     @Override
